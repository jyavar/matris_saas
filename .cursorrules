# STRATO Core OSâ„¢ - Cursor Rules

## ğŸ—ï¸ ARQUITECTURA DEL PROYECTO

STRATO es un monorepo SaaS con arquitectura modular:

```
matriz_cursor/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ backend/          # API Node.js/Express + Supabase
â”‚   â”œâ”€â”€ frontend/         # React + Vite + TypeScript
â”‚   â””â”€â”€ web/             # Next.js Landing + Control Tower
â”œâ”€â”€ packages/             # LibrerÃ­as compartidas
â”œâ”€â”€ supabase/            # Base de datos y migraciones
â””â”€â”€ scripts/             # Herramientas de desarrollo
```

## ğŸ¯ PATRONES Y CONVENCIONES

### Backend (Node.js/Express)
- **Controllers**: Manejan requests/responses, validaciÃ³n, logging
- **Services**: LÃ³gica de negocio, integraciÃ³n con APIs externas
- **Routes**: DefiniciÃ³n de endpoints REST
- **Middleware**: Auth, rate limiting, error handling, logging
- **Types**: Tipos TypeScript para Supabase y Express

### Frontend (React/Vite)
- **Components**: Reutilizables en `/components/ui/`
- **Pages**: PÃ¡ginas principales en `/app/`
- **Services**: APIs y servicios externos
- **Contexts**: Estado global (AuthContext)
- **Hooks**: LÃ³gica reutilizable

### Web (Next.js)
- **App Router**: Estructura moderna de Next.js 15
- **API Routes**: Endpoints para auditorÃ­a y control
- **Components**: Landing page y Control Tower

## ğŸ”§ TECNOLOGÃAS PRINCIPALES

### Backend
- **Node.js + Express 5**: API REST
- **TypeScript**: Tipado estÃ¡tico
- **Supabase**: Base de datos PostgreSQL + Auth
- **Stripe**: Pagos
- **OpenAI**: IA
- **PostHog**: Analytics
- **Resend**: Email
- **Pino**: Logging estructurado

### Frontend
- **React 18**: UI Framework
- **Vite**: Build tool
- **TypeScript**: Tipado estÃ¡tico
- **Tailwind CSS**: Estilos
- **Vitest**: Testing
- **MSW**: Mock Service Worker

### Web
- **Next.js 15**: Framework React
- **App Router**: Enrutamiento moderno
- **TypeScript**: Tipado estÃ¡tico

## ğŸ“ CONVENCIONES DE CÃ“DIGO

### Naming
- **Files**: kebab-case (auth.controller.ts)
- **Functions**: camelCase (getUserProfile)
- **Classes**: PascalCase (AuthService)
- **Constants**: UPPER_SNAKE_CASE (API_BASE_URL)
- **Types**: PascalCase (UserProfile)

### Imports
- **Relative**: Para archivos del mismo mÃ³dulo
- **Absolute**: Para paquetes externos
- **Workspace**: Para paquetes internos (@repo/db-types)

### Error Handling
- **Controllers**: Try/catch con next(error)
- **Services**: Throw ApiError con cÃ³digos HTTP
- **Frontend**: Error boundaries y estados de error

### Logging
- **Structured**: Pino con contexto estructurado
- **Actions**: logAction() para eventos de negocio
- **Levels**: info, warn, error segÃºn severidad

## ğŸ§ª TESTING

### Backend Tests
- **Unit**: Services y utilidades
- **Integration**: Controllers y routes
- **Mocks**: Supabase, Stripe, OpenAI, PostHog, Resend
- **Coverage**: Vitest con cobertura
- **Framework**: Vitest (`apps/backend/vitest.config.ts`)
- **Rutas de tests**: `apps/backend/src/tests/`
- **Ejemplo de mock:**
  ```ts
  vi.mock('@supabase/supabase-js', () => ({
    createClient: vi.fn(() => ({
      auth: { signInWithPassword: vi.fn() },
      from: vi.fn()
    }))
  }))
  ```

### Frontend Tests
- **Components**: React Testing Library
- **Hooks**: Custom hooks testing
- **API**: MSW para mocking
- **E2E**: Playwright (opcional)
- **Framework**: Vitest (`apps/frontend/vitest.config.ts`)
- **Rutas de tests**: `apps/frontend/src/tests/`, `apps/frontend/tests-e2e/`
- **Ejemplo de mock con MSW:**
  ```ts
  import { rest } from 'msw'
  export const handlers = [
    rest.get('/api/user', (req, res, ctx) => res(ctx.json({ id: 1 })))
  ]
  ```

### Web Tests
- **Playwright**: Para pruebas E2E (`apps/frontend/tests-e2e/`)

## ğŸ” SEGURIDAD

### Authentication
- **Supabase Auth**: JWT tokens
- **Middleware**: authMiddleware para rutas protegidas
- **Rate Limiting**: express-rate-limit
- **CORS**: Configurado para producciÃ³n
- **ValidaciÃ³n de tokens**: Siempre validar JWT en endpoints protegidos. Ejemplo:
  ```ts
  if (!req.user) return res.status(401).json({ error: 'No autorizado' })
  ```

### Environment Variables
- **Backend**: SUPABASE_URL, JWT_SECRET, etc.
- **Frontend**: VITE_SUPABASE_URL, etc.
- **Never**: Committear secrets al repo

## ğŸ“Š MONITORING

### Logging
- **Structured**: Pino con contexto estructurado
- **Levels**: info, warn, error
- **Actions**: Eventos de negocio trackeados
- **logAction()**: Usar para registrar eventos clave de negocio. Ejemplo:
  ```ts
  logAction('user_signup', userId, { email })
  ```

## ğŸ¤– AGENTES STRATO

### Agentes disponibles
- **@refactor**: RefactorizaciÃ³n automÃ¡tica de cÃ³digo. UbicaciÃ³n: `/scripts/agents/refactor/autofix.ts`
- **@qa**: AuditorÃ­a de calidad y tests. UbicaciÃ³n: `/scripts/agents/qa/`
- **@data**: Procesamiento y migraciÃ³n de datos. UbicaciÃ³n: `/scripts/agents/data/`
- **@merge-strategist**: Estrategias de merge y resoluciÃ³n de conflictos. UbicaciÃ³n: `/scripts/agents/merge-strategist/`
- **@context-watchdog**: Monitoreo de contexto y rutas. UbicaciÃ³n: `/scripts/agents/context-watchdog.ts`

### Rol y lÃ³gica principal
- Cada agente implementa una funciÃ³n principal `runAgent()` y sigue la convenciÃ³n de orquestaciÃ³n desde `RuntimeService.runAgent()`.
- Los agentes pueden ser invocados desde scripts o CI para tareas automÃ¡ticas de refactor, QA, migraciÃ³n, etc.

## ğŸŒ CONEXIONES EXTERNAS
- **Supabase**: Base de datos y autenticaciÃ³n principal.
- **Stripe**: Procesamiento de pagos y suscripciones.
- **OpenAI**: Funcionalidades de IA y generaciÃ³n de texto.
- **Resend**: EnvÃ­o de emails transaccionales.
- **PostHog**: Analytics y tracking de eventos.

## ğŸš¨ ANTI-PATRONES A EVITAR

- âŒ Committear secrets
- âŒ Any types en TypeScript
- âŒ Console.log en producciÃ³n
- âŒ Mutar props en React
- âŒ Callbacks anidados
- âŒ Variables globales
- âŒ Hardcoded URLs
- âŒ Ignorar errores de linting
- âŒ Omitir validaciÃ³n de tokens en endpoints protegidos
- âŒ No usar mocks en tests de integraciÃ³n
- âŒ No cubrir cÃ³digo crÃ­tico con tests

## ğŸ¯ OBJETIVOS DEL PROYECTO

STRATO es un framework SaaS enterprise-grade que prioriza:
- **Developer Experience**: DX excepcional
- **Code Quality**: CÃ³digo limpio y mantenible
- **Security**: Seguridad por defecto
- **Performance**: Rendimiento optimizado
- **Scalability**: Arquitectura escalable
- **Monitoring**: Observabilidad completa

## ğŸ“š RECURSOS

- **Supabase Docs**: https://supabase.com/docs
- **Next.js Docs**: https://nextjs.org/docs
- **React Docs**: https://react.dev
- **Tailwind CSS**: https://tailwindcss.com/docs
- **Vitest**: https://vitest.dev

## âœ… CHECKLISTS DE VALIDACIÃ“N

### Pull Request Checklist
- [ ] El cÃ³digo tiene tests unitarios y de integraciÃ³n
- [ ] Se validan tokens en endpoints protegidos
- [ ] Se loguean acciones clave con logAction()
- [ ] No hay secrets ni datos sensibles en el cÃ³digo
- [ ] El PR incluye descripciÃ³n clara y justificaciÃ³n de cambios
- [ ] El cÃ³digo sigue las convenciones de naming y estructura
- [ ] Se actualizaron los mocks si cambiÃ³ la integraciÃ³n externa
- [ ] El build y los tests pasan en CI

### Release Checklist
- [ ] Todos los tests pasan con cobertura mÃ­nima
- [ ] No hay dependencias inseguras o deprecated
- [ ] Se revisaron los logs de errores recientes
- [ ] Se actualizaron las migraciones y seeds si aplica
- [ ] Se revisaron los permisos y accesos de servicios externos

---

## ğŸ“ˆ COBERTURA MÃNIMA DE TESTS
- **Backend**: 90% lÃ­neas, 90% branches
- **Frontend**: 90% lÃ­neas, 90% branches
- **Bloquear PRs** si la cobertura baja de ese umbral
- **Comando**: `pnpm test:coverage` y revisar reporte

---

## ğŸš« EJEMPLOS DE ANTI-PATRONES Y FIXES

### âŒ Incorrecto
```ts
// No validar token
app.get('/api/secure', handler)

// Usar any
const data: any = {}

// Console.log en producciÃ³n
console.log('debug')

// Mutar props
props.value = 123

// Hardcoded URL
fetch('https://api.stripe.com/v1/charges')
```

### âœ… Correcto
```ts
// Validar token
app.get('/api/secure', authMiddleware, handler)

// Tipado estricto
const data: UserProfile = {}

// Logging estructurado
logger.info({ userId }, 'User logged in')

// Props inmutables
<MyComponent value={value} />

// Usar variables de entorno
fetch(`${process.env.STRIPE_API_URL}/charges`)
```

---

## ğŸ”‘ POLÃTICA DE SECRETS Y VARIABLES

| Variable                | UbicaciÃ³n         | PropÃ³sito                        |
|-------------------------|-------------------|----------------------------------|
| SUPABASE_URL            | Backend, Frontend | URL de Supabase                  |
| SUPABASE_KEY            | Backend           | API Key de Supabase              |
| JWT_SECRET              | Backend           | Firmar y validar JWT             |
| STRIPE_SECRET_KEY       | Backend           | API Key de Stripe                |
| OPENAI_API_KEY          | Backend           | API Key de OpenAI                |
| RESEND_API_KEY          | Backend           | API Key de Resend                |
| POSTHOG_API_KEY         | Backend           | API Key de PostHog               |
| VITE_SUPABASE_URL       | Frontend          | URL de Supabase (public)         |

- **Nunca** committear archivos `.env` ni valores reales
- Usar `.env.example` como plantilla
- Secrets en CI: usar GitHub Actions Secrets o Railway/Vercel envs

---

## ğŸŒ³ POLÃTICA DE BRANCHING Y RELEASES
- Solo mergear a `main` vÃ­a Pull Request
- CI debe estar en verde y cobertura OK
- RevisiÃ³n obligatoria de 2 devs para PRs a main
- Branches:
  - `main`: ProducciÃ³n
  - `develop`: IntegraciÃ³n (opcional)
  - `feature/*`: Nuevas features
  - `fix/*`: Hotfixes
  - `chore/*`: Mantenimiento
- Releases: usar tags semver (`v1.2.3`)

---

## ğŸ“¦ INTEGRIDAD DE DEPENDENCIAS
- No instalar paquetes sin justificaciÃ³n en el PR
- Usar solo versiones estables (`^x.y.z`)
- Revisar dependabot y alertas de seguridad
- Eliminar dependencias no usadas
- Revisar cambios en `pnpm-lock.yaml` en cada PR

---

## ğŸ›¡ï¸ REVISIÃ“N DE ACCESOS Y PERMISOS
- Revisar roles y permisos en Supabase periÃ³dicamente
- Rotar claves de API cada 90 dÃ­as
- Revisar accesos a Stripe, OpenAI, Resend y PostHog
- Limitar permisos de servicio a lo mÃ­nimo necesario
- Documentar cambios de permisos en el PR

---

## ğŸ•µï¸ AUDITORÃA Y OBSERVABILIDAD
- Auditar logs crÃ­ticos semanalmente
- Revisar errores y alertas en PostHog y logs de Pino
- Consultar mÃ©tricas de performance y uso
- Ejemplo de consulta de logs:
  ```sh
  pnpm logs | grep error
  ```
- Documentar incidentes y acciones correctivas

---

## ğŸ¤– AUTOMATIZACIÃ“N Y SCRIPTS CLAVE
- `pnpm lint` â€” Linting de todo el monorepo
- `pnpm test` â€” Ejecutar todos los tests
- `pnpm build` â€” Build de producciÃ³n
- `pnpm format` â€” Formato automÃ¡tico
- `pnpm check-react-imports` â€” Verifica imports de React
- `pnpm tsx scripts/agents/refactor/autofix.ts` â€” Refactor automÃ¡tico
- `pnpm tsx scripts/agents/qa/` â€” AuditorÃ­a de calidad
- `pnpm tsx scripts/agents/context-watchdog.ts` â€” Monitoreo de contexto

---

## ğŸš€ ONBOARDING EXPRESS PARA NUEVOS DEVS
1. Clona el repo y corre `pnpm install`
2. Copia `.env.example` a `.env` y configura tus variables
3. Corre `pnpm dev` para levantar backend y frontend
4. Corre `pnpm test` para validar que todo pase
5. Lee `.cursorrules` y sigue los patrones
6. Haz tu feature en una branch `feature/tu-feature`
7. Abre un PR con checklist y justificaciÃ³n
8. Pide revisiÃ³n a 2 devs y espera CI verde
9. Â¡Bienvenido a STRATO! ğŸš€

---

## ğŸ›¡ï¸ BLINDAJE DE TRAZABILIDAD - PREVENCIÃ“N DE PÃ‰RDIDA DE ARCHIVOS

### ğŸ¯ OBJETIVO
Garantizar que NUNCA se pierdan archivos, mÃ³dulos, rutas, tests o paths en el monorepo STRATO. Toda la trazabilidad debe estar documentada y validada automÃ¡ticamente.

### ğŸ“‹ HEADER JSON OBLIGATORIO PARA MÃ“DULOS

Cada mÃ³dulo debe tener un header JSON con metadata completa:

```json
{
  "module": "AUTH",
  "description": "GestiÃ³n de autenticaciÃ³n y autorizaciÃ³n",
  "paths": [
    "apps/backend/src/controllers/auth.controller.ts",
    "apps/backend/src/services/auth.service.ts",
    "apps/backend/src/routes/auth.routes.ts"
  ],
  "tests": [
    "apps/backend/src/tests/auth.test.ts",
    "apps/frontend/src/components/auth/ProtectedRoute.test.tsx"
  ],
  "routes": [
    "/api/auth/signup",
    "/api/auth/login"
  ],
  "docs": [
    "~M_AUTH.md"
  ],
  "last_synced": "2025-01-27",
  "responsible": "JosÃ© + IA STRATO",
  "coverage": 100,
  "status": "active",
  "criticality": "high"
}
```

### ğŸ“ SECCIÃ“N "ARCHIVOS CLAVE" OBLIGATORIA

Cada mÃ³dulo debe tener una secciÃ³n "Archivos clave" con:
- **Source files**: Todos los archivos .ts, .tsx, .js, .jsx
- **Test files**: Todos los archivos .test.ts, .test.tsx, .spec.ts
- **Config files**: Todos los archivos .json, .config.ts, .config.js
- **Doc files**: Todos los archivos .md relacionados
- **Scripts**: Scripts y utilidades del mÃ³dulo

### ğŸ” VALIDACIÃ“N AUTOMÃTICA EN PRE-COMMIT/PRE-PUSH

**Script de validaciÃ³n obligatorio** que detecte:
- âœ… Archivos sin declarar en headers (huÃ©rfanos)
- âœ… Rutas sin documentar en mÃ³dulos
- âœ… Tests sin asociar a mÃ³dulos
- âœ… Paths sin cobertura de trazabilidad
- âŒ **BLOQUEAR COMMIT/PUSH** si hay inconsistencias

### ğŸ”„ SINCRONIZACIÃ“N BIDIRECCIONAL

**Reglas automÃ¡ticas**:
- **Crear archivo** â†’ Actualizar header y secciÃ³n "Archivos clave" del mÃ³dulo correspondiente
- **Modificar archivo** â†’ Verificar que estÃ© en header y secciÃ³n "Archivos clave"
- **Eliminar archivo** â†’ Eliminar de header y secciÃ³n "Archivos clave"
- **Mover archivo** â†’ Actualizar paths en todos los mÃ³dulos afectados

### ğŸ“Š METADATA EXTENDIDA POR ARCHIVO

Cada entrada de archivo debe tener:

```json
{
  "path": "apps/backend/src/controllers/auth.controller.ts",
  "type": "source",
  "module": "AUTH",
  "last_synced": "2025-01-27",
  "responsible": "JosÃ©",
  "criticality": "high",
  "dependencies": ["auth.service.ts", "auth.middleware.ts"],
  "tests": ["auth.test.ts"],
  "routes": ["/api/auth/*"],
  "coverage": 95
}
```

### ğŸ“ˆ REPORTES AUTOMÃTICOS

**Generar en cada auditorÃ­a**:
- ğŸ“Š Archivos cubiertos vs. huÃ©rfanos
- ğŸ” MÃ³dulos desincronizados
- ğŸ§ª Tests no asociados
- ğŸ›£ï¸ Rutas no documentadas
- ğŸ“ˆ Progreso de cobertura de visibilidad

### ğŸš¨ INTEGRACIÃ“N CON CI/CD

**El pipeline DEBE FALLAR si**:
- âŒ Hay archivos no cubiertos por headers
- âŒ Hay rutas sin documentar
- âŒ Hay tests sin asociar
- âŒ Hay paths huÃ©rfanos
- âŒ Hay mÃ³dulos sin header JSON vÃ¡lido

### ğŸ¨ PLANTILLA PARA NUEVOS MÃ“DULOS

**Comando automÃ¡tico** para generar:
- Header JSON completo
- SecciÃ³n "Archivos clave" inicial
- Tests asociados
- DocumentaciÃ³n base
- Validaciones de integridad

### ğŸ”§ COMANDOS DE VALIDACIÃ“N

```bash
# Validar trazabilidad completa
pnpm validate-traceability

# Sincronizar mÃ³dulos
pnpm sync-modules

# Generar reporte de visibilidad
pnpm visibility-report

# Crear nuevo mÃ³dulo con plantilla
pnpm create-module --name MODULE_NAME
```

### ğŸ“‹ CHECKLIST DE BLINDAJE

**Antes de cada commit**:
- [ ] Todos los archivos estÃ¡n declarados en headers de mÃ³dulos
- [ ] Todas las rutas estÃ¡n documentadas
- [ ] Todos los tests estÃ¡n asociados
- [ ] No hay archivos huÃ©rfanos
- [ ] Headers JSON son vÃ¡lidos
- [ ] Secciones "Archivos clave" estÃ¡n actualizadas
- [ ] Metadata extendida estÃ¡ completa

**En cada PR**:
- [ ] ValidaciÃ³n de trazabilidad pasa
- [ ] Reporte de visibilidad estÃ¡ actualizado
- [ ] No hay archivos sin declarar
- [ ] MÃ³dulos estÃ¡n sincronizados

### ğŸš« ANTI-PATRONES DE TRAZABILIDAD

- âŒ **NUNCA** crear archivos sin declararlos en headers
- âŒ **NUNCA** mover archivos sin actualizar paths
- âŒ **NUNCA** eliminar archivos sin limpiar referencias
- âŒ **NUNCA** hacer commit con archivos huÃ©rfanos
- âŒ **NUNCA** omitir validaciÃ³n de trazabilidad
- âŒ **NUNCA** tener mÃ³dulos sin header JSON
- âŒ **NUNCA** tener rutas sin documentar
- âŒ **NUNCA** tener tests sin asociar

### âœ… PATRONES DE TRAZABILIDAD

- âœ… **SIEMPRE** declarar archivos en headers de mÃ³dulos
- âœ… **SIEMPRE** actualizar paths al mover archivos
- âœ… **SIEMPRE** limpiar referencias al eliminar archivos
- âœ… **SIEMPRE** validar trazabilidad antes de commit
- âœ… **SIEMPRE** mantener headers JSON actualizados
- âœ… **SIEMPRE** documentar rutas en mÃ³dulos
- âœ… **SIEMPRE** asociar tests a mÃ³dulos
- âœ… **SIEMPRE** generar reportes de visibilidad

### ğŸ¯ MÃ‰TRICAS DE Ã‰XITO

- **Cobertura de trazabilidad**: 100%
- **Archivos huÃ©rfanos**: 0
- **Rutas sin documentar**: 0
- **Tests sin asociar**: 0
- **MÃ³dulos sin header**: 0
- **Validaciones fallidas**: 0

---

## ğŸš€ ONBOARDING EXPRESS PARA NUEVOS DEVS
1. Clona el repo y corre `pnpm install`
2. Copia `.env.example` a `.env` y configura tus variables
3. Corre `pnpm dev` para levantar backend y frontend
4. Corre `pnpm test` para validar que todo pase
5. Lee `.cursorrules` y sigue los patrones
6. Haz tu feature en una branch `feature/tu-feature`
7. Abre un PR con checklist y justificaciÃ³n
8. Pide revisiÃ³n a 2 devs y espera CI verde
9. Â¡Bienvenido a STRATO! ğŸš€ 